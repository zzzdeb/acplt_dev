/******************************************************************************
 *
 *   FILE
 *   ----
 *   WriteFiles.c
 *
 *   History
 *   -------
 *   2018-04-27   File created
 *
 *******************************************************************************
 *
 *   This file is generated by the 'acplt_builder' command
 *
 ******************************************************************************/
#ifndef OV_COMPILE_LIBRARY_CTree
#define OV_COMPILE_LIBRARY_CTree
#endif

#include "CTree.h"
#include "libov/ov_macros.h"
#include "libov/ov_result.h"

/**
 * @brief create path without ENV variable. $ACPLT_HOME/dev ->
 * /com/user/....../acplt/dev, works for now only for first variable. If no
 * variable is included gives path back
 *
 * @param path
 *
 * @return
 */
OV_STRING free_varpath(const OV_STRING path) {
  OV_STRING pathWV = NULL;
  OV_STRING tmpString = NULL;
  OV_STRING currentChar = NULL;
  ov_string_setvalue(&pathWV, path);
  if(*path != '$') {
    return pathWV;
  }
  ov_string_setvalue(&tmpString, path);
  currentChar = strchr(tmpString, '/');
  *currentChar = 0;
  ov_string_setvalue(&pathWV, getenv(tmpString + 1));
  *currentChar = '/';
  if(pathWV == NULL) {
    ov_string_setvalue(&tmpString, NULL);
    return pathWV;
  }
  ov_string_append(&pathWV, currentChar);
  ov_string_setvalue(&tmpString, NULL);
  return pathWV;
}

/**
 * @brief writes blen bytes of pvalue under name
 *
 * @param path
 * @param blen
 * @param pvalue
 *
 * @return
 */
OV_RESULT bytesToFile(const OV_STRING path, OV_UINT blen,
                      const OV_BYTE* pvalue) {
  OV_RESULT result = OV_ERR_OK;
  FILE*     target_lib = NULL;
  OV_STRING varFreePath = free_varpath(path);
  target_lib = fopen(varFreePath, "wb");
  ov_string_setvalue(&varFreePath, NULL);

  OV_UINT tmp = fwrite(pvalue, sizeof(OV_BYTE), blen, target_lib);
  //	ov_logfile_info("bytes written %u %s", tmp, name);
  if(tmp != blen)
    ov_logfile_error("not enough");

  if(target_lib) {
    fclose(target_lib);
    //		ov_logfile_info("closing file");
  }
  return result;
}

/* writes files */
OV_DLLFNCEXPORT OV_RESULT
                CTree_WriteFiles_write(OV_INSTPTR_CTree_WriteFiles pinst) {
  OV_RESULT result = OV_ERR_OK;

  //	if(pinst->v_filesPositions || pinst->v_filesToWrite	||
  // pinst->v_byteFiles){}

  Ov_WarnIfNot(pinst->v_filesPositions.veclen == pinst->v_filesToWrite.veclen);
  Ov_WarnIfNot(
      pinst->v_filesPositions.value[pinst->v_filesPositions.veclen - 1] ==
      pinst->v_byteFiles.value.valueunion.val_byte_vec.veclen);
  Ov_WarnIfNot(pinst->v_filesPositions.value);
  Ov_WarnIfNot(pinst->v_filesToWrite.value);
  Ov_WarnIfNot(pinst->v_byteFiles.value.valueunion.val_byte_vec.value);

  OV_BYTE*  pvalue = pinst->v_byteFiles.value.valueunion.val_byte_vec.value;
  OV_UINT   len = pinst->v_filesToWrite.veclen;
  OV_UINT   blen = 0;
  OV_STRING fileName = NULL;
  for(OV_UINT i = 0; i < len; i++) {
    blen = i ? pinst->v_filesPositions.value[i] -
                   pinst->v_filesPositions.value[i - 1]
             : pinst->v_filesPositions.value[0];
    result =
        bytesToFile(pinst->v_filesToWrite.value[i], blen,
                    pvalue + (i ? pinst->v_filesPositions.value[i - 1] : 0));
    if(Ov_OK(result)) {
      ov_logfile_info("In file %s %u bytes writen",
                      pinst->v_filesToWrite.value[i], blen);
    } else {
      ov_logfile_error("Error at writing file %s : %s", fileName,
                       ov_result_getresulttext(result));
    }
  }
  /*clean*/
  ov_string_setvalue(&fileName, NULL);

  return OV_ERR_OK;
}

OV_DLLFNCEXPORT void
CTree_WriteFiles_typemethod(OV_INSTPTR_fb_functionblock pfb, OV_TIME* pltc) {
  /*
   *   local variables
   */
  OV_INSTPTR_CTree_WriteFiles pinst = Ov_StaticPtrCast(CTree_WriteFiles, pfb);
  OV_RESULT                   result = OV_ERR_OK;
  result = CTree_WriteFiles_write(pinst);
  pinst->v_actimode = 0;
  switch(result) {
    case OV_ERR_OK:
      pinst->v_result = result;
      ov_logfile_info("Successfully written.");
      break;
    default:
      pinst->v_result = !!result;
      ov_logfile_error("%u: %s", result, ov_result_getresulttext(result));
  }

  return;
}
